<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard - Food By Bella</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
    }

    header {
      background-color: #b30000;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
    }

    .admin-container {
      display: flex;
    }

    nav {
      width: 200px;
      background-color: #333;
      height: 100vh;
      padding-top: 20px;
    }

    nav a {
      display: block;
      color: white;
      padding: 10px;
      text-decoration: none;
    }

    nav a:hover {
      background-color: #575757;
    }

    main {
      flex: 1;
      padding: 20px;
    }

    .card {
      background-color: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    h2 {
      color: #b30000;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    button {
      background-color: gold;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      color: #b30000;
      font-weight: bold;
      border-radius: 5px;
      margin-right: 5px;
    }

    button:hover {
      background-color: #e6c200;
    }

    .analytics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .analytics .card {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .highlight {
      background: #d1ffd1 !important;
      transition: background 1s ease;
    }
  </style>
</head>
<body>

<header>
  Food By Bella - Admin Dashboard
</header>

<div class="admin-container">
  <nav>
    <a href="#" onclick="showSection('orders')">Orders</a>
    <a href="#" onclick="showSection('customers')">Customers</a>
    <button onclick="logout()">Logout</button> 
  </nav>

  <main>
    <div class="analytics">
      <div class="card">üì¶ Orders Today: <span id="ordersToday">0</span></div>
      <div class="card">üí∞ Revenue Today: ‚Ç¶<span id="revenueToday">0</span></div>
      <div class="card">üë®‚Äçüë©‚Äçüëß Customers: <span id="totalCustomers">0</span></div>
      <div class="card">üç≤ Best-Selling Dish: <span id="bestDish">-</span></div>
    </div>

    <div id="orders" class="card">
      <h2>Orders Management</h2>
      <table id="ordersTable">
        <tr>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Address</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Actions</th>
        </tr>
      </table>
    </div>

    <div id="customers" class="card" style="display:none;">
      <h2>Customer Management</h2>
      <table id="customersTable">
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
        </tr>
      </table>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, getDocs, doc, getDoc, collection, onSnapshot, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAM6Aw5rI5ysxlJ8osuozlV1OdVy3QqJJ4",
    authDomain: "my-restaurant-app-8c40b.firebaseapp.com",
    projectId: "my-restaurant-app-8c40b",
    storageBucket: "my-restaurant-app-8c40b.firebasestorage.app",
    messagingSenderId: "744991278655",
    appId: "1:744991278655:web:a3c4975525c5f9d57f5a8a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("Please login first!");
      window.location.href = "login.html";
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists() || userSnap.data().role !== "admin") {
      alert("Access denied! Admins only.");
      window.location.href = "dashboard.html";
      return;
    }

    console.log(`‚úÖ Welcome Admin: ${userSnap.data().username}`);
    loadOrdersRealTime();
    loadCustomers();
    loadAnalytics();
  });

  function loadOrdersRealTime() {
    const ordersTable = document.getElementById("ordersTable");

    const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      ordersTable.innerHTML = `
        <tr>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Address</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Actions</th>
        </tr>`;

      snapshot.forEach(docSnap => {
        const order = docSnap.data();
        const row = ordersTable.insertRow();

        row.insertCell(0).innerText = order.customer || "Unknown";
        row.insertCell(1).innerText = (order.items || []).map(i => `${i.name} (x${i.quantity})`).join(", ");
        row.insertCell(2).innerText = `‚Ç¶${(order.total || 0).toLocaleString()}`;
        row.insertCell(3).innerText = order.address || "No Address";
        row.insertCell(4).innerText = order.status || "pending";
        row.insertCell(5).innerText = order.paymentStatus || "unpaid";

        const actionsCell = row.insertCell(6);
        actionsCell.innerHTML = `
          <button onclick="viewOrder('${docSnap.id}')">View</button>
          <button onclick="updateOrderStatus('${docSnap.id}', 'delivered')">Deliver</button>
          <button onclick="updateOrderStatus('${docSnap.id}', 'cancelled')">Cancel</button>
        `;

        if (order.paymentStatus === "paid" && order.status === "pending") {
          row.classList.add("highlight");
          setTimeout(() => row.classList.remove("highlight"), 5000);
        }
      });
    });
  }

  async function loadCustomers() {
    const customersTable = document.getElementById("customersTable");
    customersTable.innerHTML = "<tr><th>Username</th><th>Email</th><th>Role</th></tr>";

    const querySnapshot = await getDocs(collection(db, "users"));
    querySnapshot.forEach(docSnap => {
      const user = docSnap.data();
      const row = customersTable.insertRow();
      row.insertCell(0).innerText = user.username || "No Name";
      row.insertCell(1).innerText = user.email;
      row.insertCell(2).innerText = user.role;
    });
  }

  async function loadAnalytics() {
    const ordersSnap = await getDocs(collection(db, "orders"));
    const usersSnap = await getDocs(collection(db, "users"));

    let todayOrders = 0;
    let todayRevenue = 0;
    let dishCount = {};

    const today = new Date().toDateString();

    ordersSnap.forEach(docSnap => {
      const order = docSnap.data();
      if (!order.createdAt) return;

      const orderDate = order.createdAt.toDate().toDateString();

      if (orderDate === today) {
        todayOrders++;
        if (order.paymentStatus === "paid") {
          todayRevenue += order.total || 0;
        }
      }

      (order.items || []).forEach(i => {
        dishCount[i.name] = (dishCount[i.name] || 0) + i.quantity;
      });
    });

    let bestDish = "-";
    let maxCount = 0;
    for (let dish in dishCount) {
      if (dishCount[dish] > maxCount) {
        maxCount = dishCount[dish];
        bestDish = dish;
      }
    }

    document.getElementById("ordersToday").innerText = todayOrders;
    document.getElementById("revenueToday").innerText = todayRevenue.toLocaleString();
    document.getElementById("totalCustomers").innerText = usersSnap.size;
    document.getElementById("bestDish").innerText = bestDish;
  }

  window.updateOrderStatus = async function (orderId, newStatus) {
    const orderRef = doc(db, "orders", orderId);
    await updateDoc(orderRef, { status: newStatus });
    alert(`Order ${orderId} marked as ${newStatus}`);
  }

  window.viewOrder = async function (orderId) {
    const orderRef = doc(db, "orders", orderId);
    const orderSnap = await getDoc(orderRef);
    if (orderSnap.exists()) {
      const order = orderSnap.data();
      alert(`
        üìå Order ID: ${orderId}
        üë§ Customer: ${order.fullName} (${order.customer})
        üìû Phone: ${order.phone}
        üè† Address: ${order.address}
        üìù Note: ${order.note || "None"}
        üí∞ Total: ‚Ç¶${order.total}
        üí≥ Payment: ${order.paymentStatus}
        üîñ Status: ${order.status}
      `);
    }
  }

  window.logout = function () {
    if (confirm("Are you sure you want to logout?")) {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      }).catch((error) => {
        console.error("Logout error:", error);
        alert("Failed to logout, please try again.");
      });
    }
  }
</script>
</body>
</html>
